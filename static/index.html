<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ycal</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      *:focus-visible {
        outline: 2px solid #e63946;
        outline-offset: 2px;
      }

      *:focus:not(:focus-visible) {
        outline: none;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
        background: #111122;
      }

      .controls {
        width: 280px;
        padding: 24px;
        background: #1a1a2e;
        color-scheme: dark;
        box-shadow: 4px 0 24px rgba(0,0,0,0.3), 1px 0 8px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        gap: 16px;
        overflow-y: auto;
        flex-shrink: 0;
        visibility: hidden;
      }

      .controls h1 {
        font-size: 20px;
        font-weight: 600;
        color: white;
        letter-spacing: -0.02em;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .field label {
        font-size: 13px;
        font-weight: 500;
        color: #a0a0b8;
      }

      .field input,
      .field select {
        padding: 10px 12px;
        background: #252540;
        border: 1px solid #3a3a55;
        border-radius: 8px;
        font-size: 14px;
        color: white;
        transition: border-color 0.15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .field input:hover,
      .field select:hover {
        border-color: #4a4a65;
      }

      .field input:focus,
      .field select:focus {
        border-color: #e63946;
        box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.15);
        outline: none;
      }

      .field select option {
        background: #252540;
        color: white;
      }

      .field-group {
        border: 1px solid #3a3a55;
        border-radius: 8px;
        padding: 0 12px;
      }

      .field-group summary {
        font-size: 13px;
        font-weight: 500;
        color: #a0a0b8;
        cursor: pointer;
        padding: 10px 0;
      }

      .field-group summary:hover {
        color: white;
      }

      .field-group .field {
        margin-bottom: 12px;
      }

      .field-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .field-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }

      .field-row label {
        font-size: 14px;
        color: #c0c0d0;
      }

      .btn-secondary {
        background: transparent;
        border: 1.5px solid #3a3a55;
        color: #c0c0d0;
        font-size: 13px;
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn-secondary:hover {
        background: #252540;
        border-color: #4a4a65;
      }

      .btn-secondary:disabled {
        background: transparent;
        border-color: #2a2a40;
        color: #555570;
        cursor: default;
      }

      button {
        padding: 8px 16px;
        background: #e63946;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      button:hover {
        background: #ef4444;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(230, 57, 70, 0.3);
      }

      button:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .link-btn {
        background: none;
        border: none;
        padding: 0;
        font-size: 12px;
        color: #8888a0;
        cursor: pointer;
      }

      .link-btn:hover {
        text-decoration: underline;
        background: none;
        transform: none;
        box-shadow: none;
        color: #8888a0;
      }

      .link-btn:active {
        transform: none;
        box-shadow: none;
      }

      .special-day-add {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 6px;
      }

      .special-day-add input[type="date"],
      .special-day-add input[type="text"] {
        padding: 10px 12px;
        background: #252540;
        border: 1px solid #3a3a55;
        border-radius: 8px;
        font-size: 14px;
        color: white;
        transition: border-color 0.15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .special-day-add input[type="date"]:hover,
      .special-day-add input[type="text"]:hover {
        border-color: #4a4a65;
      }

      .special-day-add input[type="date"]:focus,
      .special-day-add input[type="text"]:focus {
        border-color: #e63946;
        box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.15);
        outline: none;
      }

      .special-day-add-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .small-label {
        font-size: 13px;
        color: #a0a0b8;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .small-label input[type="checkbox"] {
        width: 14px;
        height: 14px;
      }

      .btn-small {
        padding: 4px 10px;
        font-size: 13px;
      }

      .special-day-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        font-size: 13px;
        background: #252540;
        border-radius: 6px;
        margin-bottom: 3px;
        transition: background 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .special-day-item:hover {
        background: #2a2a4a;
      }

      .special-day-item .sd-info {
        display: flex;
        flex-direction: column;
        min-width: 0;
        flex: 1;
      }

      .special-day-item .sd-date {
        color: #8888a0;
        font-size: 11px;
      }

      .special-day-item .sd-name {
        color: white;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .special-day-item .sd-remove {
        background: none;
        color: #8888a0;
        border: none;
        padding: 2px 6px;
        font-size: 16px;
        cursor: pointer;
        flex-shrink: 0;
        transition: color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .special-day-item .sd-remove:hover {
        color: white;
        background: none;
        transform: none;
        box-shadow: none;
      }

      .special-day-item .sd-edit {
        background: none;
        color: #8888a0;
        border: none;
        padding: 2px 6px;
        font-size: 13px;
        cursor: pointer;
        flex-shrink: 0;
        transition: color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .special-day-item .sd-edit:hover {
        color: white;
        background: none;
        transform: none;
        box-shadow: none;
      }

      .sd-edit-form {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 100%;
        padding: 8px 10px;
        background: #252540;
        border-radius: 6px;
        margin-bottom: 4px;
      }

      .sd-edit-form input[type="date"],
      .sd-edit-form input[type="text"] {
        padding: 6px 8px;
        background: #1a1a2e;
        border: 1px solid #3a3a55;
        border-radius: 6px;
        font-size: 13px;
        color: white;
        transition: border-color 0.15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .sd-edit-form input[type="date"]:focus,
      .sd-edit-form input[type="text"]:focus {
        border-color: #e63946;
        box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.15);
        outline: none;
      }

      .sd-edit-form .sd-edit-buttons {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .sd-edit-form .btn-small {
        padding: 3px 8px;
        font-size: 12px;
      }

      .sd-edit-form .btn-cancel {
        background: transparent;
        border: 1.5px solid #3a3a55;
        color: #c0c0d0;
      }

      .sd-edit-form .btn-cancel:hover {
        background: #1a1a2e;
        border-color: #4a4a65;
      }

      .zoom-controls {
        position: fixed;
        bottom: 24px;
        right: 24px;
        display: flex;
        align-items: center;
        gap: 4px;
        background: #1a1a2e;
        border: 1px solid #3a3a55;
        border-radius: 8px;
        padding: 4px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.3), 0 2px 6px rgba(0,0,0,0.2);
        z-index: 10;
      }

      .zoom-controls button {
        width: 32px;
        height: 32px;
        padding: 0;
        font-size: 18px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .zoom-controls button:disabled {
        background: transparent;
        color: #555570;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .zoom-controls button:disabled:hover {
        background: transparent;
        transform: none;
        box-shadow: none;
      }

      .zoom-controls span {
        font-size: 13px;
        color: #a0a0b8;
        min-width: 44px;
        text-align: center;
        cursor: pointer;
        transition: color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .zoom-controls span:hover {
        color: white;
      }

      @media print {
        .zoom-controls {
          display: none !important;
        }
      }

      .preview {
        flex: 1;
        min-width: 0;
        overflow: auto;
      }

      .iframe-wrapper {
        position: relative;
        margin: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 2px 12px rgba(0,0,0,0.3);
      }

      .iframe-wrapper iframe {
        border: none;
        width: 297mm;
        height: 420mm;
        position: absolute;
        top: 0;
        left: 0;
        transform-origin: top left;
        background: white;
        visibility: hidden;
      }

      .overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }

      .overlay.visible {
        display: block;
      }

      .fab-group {
        display: none;
      }

      .panel-close {
        display: none;
      }

      @media (max-width: 767px) {
        body {
          display: block;
          overflow: visible;
        }

        .controls {
          position: fixed;
          left: 0;
          top: 0;
          height: 100vh;
          height: 100dvh;
          width: 85vw;
          max-width: 320px;
          transform: translateX(-100%);
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          background: rgba(26, 26, 46, 0.92);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          z-index: 100;
          box-shadow: none;
        }

        .controls.open {
          transform: translateX(0);
          box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
        }

        .panel-close {
          display: block;
          position: absolute;
          top: 16px;
          right: 16px;
          background: none;
          border: none;
          color: #a0a0b8;
          font-size: 22px;
          padding: 4px 8px;
          cursor: pointer;
          line-height: 1;
        }

        .panel-close:hover {
          color: white;
          background: none;
          transform: none;
          box-shadow: none;
        }

        .preview {
          width: 100vw;
          height: 100vh;
          height: 100dvh;
          overflow: auto;
          position: relative;
          touch-action: pan-x pan-y;
        }

        .iframe-wrapper {
          margin: 8px auto;
        }

        .iframe-wrapper iframe {
          pointer-events: none;
        }

        .zoom-controls {
          display: none !important;
        }

        .fab-group {
          display: flex;
          position: fixed;
          bottom: 20px;
          right: 16px;
          gap: 10px;
          z-index: 10;
        }

        .fab-group button {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          padding: 0;
          background: #1a1a2e;
          border: 1px solid #3a3a55;
          color: white;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .fab-group button:hover {
          background: #252540;
          transform: none;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .fab-group button:active {
          background: #252540;
        }

        .field input,
        .field select {
          padding: 12px 14px;
          font-size: 16px;
        }

        .field-row input[type="checkbox"] {
          width: 20px;
          height: 20px;
        }

      }

      @media print {
        .overlay,
        .fab-group {
          display: none !important;
        }

        @page {
          margin: 0 !important;
        }

        body {
          margin: 0 !important;
        }

        .controls {
          display: none !important;
        }

        .preview {
          padding: 0 !important;
        }

        .iframe-wrapper {
          width: 100vw !important;
          height: 100vh !important;
          box-shadow: none;
          margin: 0;
        }

        .iframe-wrapper iframe {
          width: 100vw !important;
          height: 100vh !important;
          transform: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="overlay" id="overlay"></div>
    <div class="controls" id="controls-panel">
      <button class="panel-close" id="panel-close" title="Close">&times;</button>
      <h1>ycal</h1>

      <div class="field">
        <label for="year">Year</label>
        <input type="number" id="year" min="1" max="9999">
      </div>

      <div class="field">
        <label for="locale">Locale</label>
        <select id="locale">
          <option value="da-DK">Danish (da-DK)</option>
          <option value="nl-NL">Dutch (nl-NL)</option>
          <option value="en-GB" selected>English (en-GB)</option>
          <option value="en-US">English (en-US)</option>
          <option value="fi-FI">Finnish (fi-FI)</option>
          <option value="fr-FR">French (fr-FR)</option>
          <option value="de-DE">German (de-DE)</option>
          <option value="it-IT">Italian (it-IT)</option>
          <option value="ja-JP">Japanese (ja-JP)</option>
          <option value="nb-NO">Norwegian (nb-NO)</option>
          <option value="pl-PL">Polish (pl-PL)</option>
          <option value="pt-PT">Portuguese (pt-PT)</option>
          <option value="es-ES">Spanish (es-ES)</option>
          <option value="sv-SE">Swedish (sv-SE)</option>
          <option value="">Custom...</option>
        </select>
        <input id="locale-custom" placeholder="e.g. sv-SE" style="display:none">
      </div>

      <div class="field">
        <label for="theme">Theme</label>
        <select id="theme">
          <option value="contemporary">Contemporary</option>
          <option value="minimalist" selected>Minimalist</option>
          <option value="retro">Retro</option>
        </select>
      </div>

      <div class="field">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <label>Special days</label>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="link-btn" id="load-holidays-btn" onclick="loadPublicHolidays()">Generate</button>
            <span style="color:#555570;font-size:12px">&middot;</span>
            <button class="link-btn" id="clear-sd-btn" onclick="clearSpecialDays()">Clear</button>
          </div>
        </div>
        <div id="special-days-list"></div>
        <div class="special-day-add">
          <input type="date" id="sd-date">
          <input type="text" id="sd-name" placeholder="Name">
          <div class="special-day-add-row">
            <label class="small-label"><input type="checkbox" id="sd-holiday"> Holiday</label>
            <button class="btn-small" onclick="addSpecialDay()">Add</button>
          </div>
        </div>
      </div>

      <details class="field-group">
        <summary>Advanced</summary>
        <div class="field">
          <label for="day-chars">Number of characters for day names</label>
          <input type="number" id="day-chars" min="1" value="1">
        </div>
        <div class="field">
          <label for="day-font-size">Day font size (pt)</label>
          <input type="number" id="day-font-size" step="0.5" value="10">
        </div>
        <div class="field">
          <label for="month-font-size">Month font size (pt)</label>
          <input type="number" id="month-font-size" step="0.5" value="10">
        </div>
        <div class="field">
          <label for="week-number-font-size">Week number font size (pt)</label>
          <input type="number" id="week-number-font-size" step="0.5" value="6">
        </div>
        <div class="field">
          <label for="special-day-font-size">Special day font size (pt)</label>
          <input type="number" id="special-day-font-size" step="0.5" value="6">
        </div>
        <div class="field">
          <label for="notes-space">Space for notes (mm)</label>
          <input type="number" id="notes-space" step="1" value="40">
        </div>
      </details>

      <div style="margin-top:auto;display:flex;gap:8px">
        <button class="btn-secondary" onclick="resetState()" style="flex:1">&#x21BA; Reset</button>
        <button onclick="printCalendar()" style="flex:1">&#x1F5A8; Print</button>
      </div>
    </div>

    <div class="preview">
      <div class="iframe-wrapper" id="iframe-wrapper">
        <iframe id="preview-frame"></iframe>
      </div>
    </div>

    <div class="zoom-controls">
      <button id="zoom-out-btn" onclick="zoomOut()" title="Zoom out" disabled>−</button>
      <span id="zoom-label" onclick="resetZoom()" title="Reset zoom">Auto</span>
      <button onclick="zoomIn()" title="Zoom in">+</button>
    </div>

    <div class="fab-group">
      <button onclick="openPanel()" title="Settings">&#9881;</button>
    </div>

    <script type="module">
      import init, { generate_calendar } from './ycal.js';

      const iframe = document.getElementById('preview-frame');
      const yearInput = document.getElementById('year');
      const localeSelect = document.getElementById('locale');
      const localeCustom = document.getElementById('locale-custom');
      const themeSelect = document.getElementById('theme');
      const dayCharsInput = document.getElementById('day-chars');
      const dayFontSizeInput = document.getElementById('day-font-size');
      const monthFontSizeInput = document.getElementById('month-font-size');
      const weekNumberFontSizeInput = document.getElementById('week-number-font-size');
      const specialDayFontSizeInput = document.getElementById('special-day-font-size');
      const notesSpaceInput = document.getElementById('notes-space');

      // Mobile panel
      const controlsPanel = document.getElementById('controls-panel');
      const overlay = document.getElementById('overlay');
      const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

      window.openPanel = function() {
        controlsPanel.classList.add('open');
        overlay.classList.add('visible');
      };

      window.closePanel = function() {
        controlsPanel.classList.remove('open');
        overlay.classList.remove('visible');
      };

      overlay.addEventListener('click', closePanel);
      document.getElementById('panel-close').addEventListener('click', closePanel);

      // Swipe left to close panel
      let touchStartX = 0;
      let touchStartY = 0;
      controlsPanel.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }, { passive: true });
      controlsPanel.addEventListener('touchend', (e) => {
        const dx = e.changedTouches[0].clientX - touchStartX;
        const dy = e.changedTouches[0].clientY - touchStartY;
        if (dx < -60 && Math.abs(dy) < Math.abs(dx)) closePanel();
      }, { passive: true });

      // Mobile pinch-to-zoom on preview (1-finger pan is native scroll)
      let pinchStartDist = 0;
      let pinchStartScale = 1;
      let mobileZoom = 1;
      const previewEl = document.querySelector('.preview');
      const wrapperEl = document.getElementById('iframe-wrapper');

      function getTouchDist(t1, t2) {
        const dx = t1.clientX - t2.clientX;
        const dy = t1.clientY - t2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }

      previewEl.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          pinchStartDist = getTouchDist(e.touches[0], e.touches[1]);
          pinchStartScale = mobileZoom;
        }
      }, { passive: true });

      previewEl.addEventListener('touchmove', (e) => {
        if (e.touches.length !== 2) return;
        e.preventDefault();
        const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
        const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
        const scrollMidX = midX + previewEl.scrollLeft - previewEl.getBoundingClientRect().left;
        const scrollMidY = midY + previewEl.scrollTop - previewEl.getBoundingClientRect().top;
        const oldZoom = mobileZoom;
        const dist = getTouchDist(e.touches[0], e.touches[1]);
        mobileZoom = Math.max(1, Math.min(5, pinchStartScale * (dist / pinchStartDist)));
        scaleMobilePreview();
        const ratio = mobileZoom / oldZoom;
        previewEl.scrollLeft = scrollMidX * ratio - (midX - previewEl.getBoundingClientRect().left);
        previewEl.scrollTop = scrollMidY * ratio - (midY - previewEl.getBoundingClientRect().top);
      }, { passive: false });

      previewEl.addEventListener('touchend', (e) => {
        if (e.touches.length === 0 && mobileZoom <= 1.05) {
          mobileZoom = 1;
          scaleMobilePreview();
          previewEl.scrollLeft = 0;
          previewEl.scrollTop = 0;
        }
      }, { passive: true });

      function scaleMobilePreview() {
        const pad = 16;
        const iframeW = 1122.5;  // 297mm
        const iframeH = 1587.4;  // 420mm (2 × 210mm)
        const availW = previewEl.clientWidth - pad;
        const fitScale = Math.min(availW / iframeW, 1);
        const scale = fitScale * mobileZoom;
        iframe.style.transform = 'scale(' + scale + ')';
        wrapperEl.style.width = (iframeW * scale) + 'px';
        wrapperEl.style.height = (iframeH * scale) + 'px';
      }

      function getLocale() {
        return localeCustom.style.display === 'none' ? localeSelect.value : localeCustom.value;
      }

      const specialDays = [];
      const sdDateInput = document.getElementById('sd-date');
      const sdNameInput = document.getElementById('sd-name');
      const sdHolidayCheckbox = document.getElementById('sd-holiday');
      const sdList = document.getElementById('special-days-list');

      sdDateInput.addEventListener('input', () => { sdDateInput.style.borderColor = ''; });
      sdNameInput.addEventListener('input', () => { sdNameInput.style.borderColor = ''; });
      sdDateInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addSpecialDay(); });
      sdNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addSpecialDay(); });

      window.addSpecialDay = function() {
        const date = sdDateInput.value;
        const name = sdNameInput.value.trim();
        sdDateInput.style.borderColor = date ? '' : '#e53e3e';
        sdNameInput.style.borderColor = name ? '' : '#e53e3e';
        if (!date || !name) return;
        specialDays.push({ date, name, is_holiday: sdHolidayCheckbox.checked });
        sdDateInput.value = '';
        sdNameInput.value = '';
        sdHolidayCheckbox.checked = false;
        renderSpecialDays();
        updatePreview();
      };

      window.loadPublicHolidays = async function() {
        const btn = document.getElementById('load-holidays-btn');
        const locale = getLocale();
        const year = yearInput.value;
        const countryCode = locale.split('-')[1];
        if (!countryCode) return;
        btn.disabled = true;
        btn.textContent = '\u2026';
        try {
          const res = await fetch('https://date.nager.at/api/v3/PublicHolidays/' + encodeURIComponent(year) + '/' + encodeURIComponent(countryCode));
          if (!res.ok) throw new Error(await res.text());
          const holidays = await res.json();
          const existing = new Set(specialDays.map(sd => sd.date));
          for (const h of holidays) {
            if (!existing.has(h.date)) {
              specialDays.push({ date: h.date, name: h.localName, is_holiday: true });
            }
          }
          renderSpecialDays();
          updatePreview();
        } catch (e) {
        }
        btn.textContent = 'Generate';
        btn.disabled = false;
      };

      window.removeSpecialDay = function(index) {
        specialDays.splice(index, 1);
        renderSpecialDays();
        updatePreview();
      };

      window.clearSpecialDays = function() {
        specialDays.length = 0;
        renderSpecialDays();
        updatePreview();
      };

      window.renderSpecialDays = function() {
        sdList.innerHTML = specialDays.map((sd, i) =>
          '<div class="special-day-item">' +
            '<div class="sd-info">' +
              '<span class="sd-name">' + sd.name + (sd.is_holiday ? ' (holiday)' : '') + '</span>' +
              '<span class="sd-date">' + sd.date + '</span>' +
            '</div>' +
            '<button class="sd-edit" onclick="editSpecialDay(' + i + ')" title="Edit">&#9998;</button>' +
            '<button class="sd-remove" onclick="removeSpecialDay(' + i + ')" title="Remove">&times;</button>' +
          '</div>'
        ).join('');
      };

      window.editSpecialDay = function(index) {
        const sd = specialDays[index];
        const item = sdList.children[index];
        item.outerHTML =
          '<div class="sd-edit-form">' +
            '<input type="date" id="sd-edit-date-' + index + '" value="' + sd.date + '" onkeydown="if(event.key===\'Enter\')saveSpecialDay(' + index + ')">' +
            '<input type="text" id="sd-edit-name-' + index + '" value="' + sd.name.replace(/"/g, '&quot;') + '" onkeydown="if(event.key===\'Enter\')saveSpecialDay(' + index + ')">' +
            '<div class="sd-edit-buttons">' +
              '<label class="small-label"><input type="checkbox" id="sd-edit-holiday-' + index + '"' + (sd.is_holiday ? ' checked' : '') + '> Holiday</label>' +
              '<div style="display:flex;gap:4px">' +
                '<button class="btn-small btn-cancel" onclick="renderSpecialDays()">Cancel</button>' +
                '<button class="btn-small" onclick="saveSpecialDay(' + index + ')">Save</button>' +
              '</div>' +
            '</div>' +
          '</div>';
      };

      window.saveSpecialDay = function(index) {
        const date = document.getElementById('sd-edit-date-' + index).value;
        const name = document.getElementById('sd-edit-name-' + index).value.trim();
        if (!date || !name) return;
        specialDays[index] = { date, name, is_holiday: document.getElementById('sd-edit-holiday-' + index).checked };
        renderSpecialDays();
        saveState();
        updatePreview();
      };

      function saveState() {
        const state = {
          year: parseInt(yearInput.value),
          locale: localeSelect.value,
          localeCustom: localeCustom.value,
          theme: themeSelect.value,
          dayChars: parseInt(dayCharsInput.value),
          dayFontSize: parseFloat(dayFontSizeInput.value),
          monthFontSize: parseFloat(monthFontSizeInput.value),
          weekNumberFontSize: parseFloat(weekNumberFontSizeInput.value),
          specialDayFontSize: parseFloat(specialDayFontSizeInput.value),
          notesSpace: parseFloat(notesSpaceInput.value),
          specialDays: specialDays,
        };
        try { localStorage.setItem('ycal-state', JSON.stringify(state)); } catch(e) {}
        try { history.replaceState(null, '', '#' + btoa(JSON.stringify(state))); } catch(e) {}
      }

      function loadState() {
        let state;
        if (location.hash.length > 1) {
          try { state = JSON.parse(atob(location.hash.slice(1))); } catch(e) {}
        }
        if (!state) {
          try { state = JSON.parse(localStorage.getItem('ycal-state')); } catch(e) {}
        }
        if (!state) {
          yearInput.value = new Date().getFullYear();
          return;
        }
        yearInput.value = state.year || new Date().getFullYear();
        if (state.locale !== undefined) localeSelect.value = state.locale;
        if (state.locale === '') {
          localeCustom.style.display = '';
          localeCustom.value = state.localeCustom || '';
        }
        if (state.theme) themeSelect.value = state.theme;
        if (state.dayChars) dayCharsInput.value = state.dayChars;
        if (state.dayFontSize) dayFontSizeInput.value = state.dayFontSize;
        if (state.monthFontSize) monthFontSizeInput.value = state.monthFontSize;
        if (state.weekNumberFontSize) weekNumberFontSizeInput.value = state.weekNumberFontSize;
        if (state.specialDayFontSize) specialDayFontSizeInput.value = state.specialDayFontSize;
        if (state.notesSpace !== undefined) notesSpaceInput.value = state.notesSpace;
        if (Array.isArray(state.specialDays)) {
          specialDays.length = 0;
          state.specialDays.forEach(sd => specialDays.push(sd));
          renderSpecialDays();
        }
      }

      window.resetState = function() {
        try { localStorage.removeItem('ycal-state'); } catch(e) {}
        history.replaceState(null, '', location.pathname);
        yearInput.value = new Date().getFullYear();
        localeSelect.value = 'en-GB';
        localeCustom.style.display = 'none';
        localeCustom.value = '';
        themeSelect.value = 'minimalist';
        dayCharsInput.value = 1;
        dayFontSizeInput.value = 10;
        monthFontSizeInput.value = 10;
        weekNumberFontSizeInput.value = 6;
        specialDayFontSizeInput.value = 6;
        notesSpaceInput.value = 40;
        specialDays.length = 0;
        renderSpecialDays();
        updatePreview();
      };

      function updatePreview() {
        const params = JSON.stringify({
          year: parseInt(yearInput.value),
          locale: getLocale(),
          theme: themeSelect.value,
          day_name_characters: parseInt(dayCharsInput.value),
          day_font_size: parseFloat(dayFontSizeInput.value),
          month_font_size: parseFloat(monthFontSizeInput.value),
          week_number_font_size: parseFloat(weekNumberFontSizeInput.value),
          special_day_font_size: parseFloat(specialDayFontSizeInput.value),
          notes_space: parseFloat(notesSpaceInput.value),
          special_days: specialDays,
        });
        try {
          const html = generate_calendar(params);
          iframe.srcdoc = html;
        } catch (e) {
          iframe.srcdoc = '<pre style="color:red;padding:1em">' + e + '</pre>';
        }
        saveState();
      }

      let yearTimeout;
      yearInput.addEventListener('input', () => {
        clearTimeout(yearTimeout);
        yearTimeout = setTimeout(updatePreview, 400);
      });

      localeSelect.addEventListener('change', () => {
        if (localeSelect.value === '') {
          localeCustom.style.display = '';
          localeCustom.focus();
        } else {
          localeCustom.style.display = 'none';
          localeCustom.value = '';
          updatePreview();
        }
      });

      let localeCustomTimeout;
      localeCustom.addEventListener('input', () => {
        clearTimeout(localeCustomTimeout);
        localeCustomTimeout = setTimeout(updatePreview, 400);
      });

      themeSelect.addEventListener('change', updatePreview);
      let dayCharsTimeout;
      dayCharsInput.addEventListener('input', () => {
        clearTimeout(dayCharsTimeout);
        dayCharsTimeout = setTimeout(updatePreview, 400);
      });
      let dayFontSizeTimeout;
      dayFontSizeInput.addEventListener('input', () => {
        clearTimeout(dayFontSizeTimeout);
        dayFontSizeTimeout = setTimeout(updatePreview, 400);
      });
      let monthFontSizeTimeout;
      monthFontSizeInput.addEventListener('input', () => {
        clearTimeout(monthFontSizeTimeout);
        monthFontSizeTimeout = setTimeout(updatePreview, 400);
      });
      let weekNumberFontSizeTimeout;
      weekNumberFontSizeInput.addEventListener('input', () => {
        clearTimeout(weekNumberFontSizeTimeout);
        weekNumberFontSizeTimeout = setTimeout(updatePreview, 400);
      });
      let specialDayFontSizeTimeout;
      specialDayFontSizeInput.addEventListener('input', () => {
        clearTimeout(specialDayFontSizeTimeout);
        specialDayFontSizeTimeout = setTimeout(updatePreview, 400);
      });
      let notesSpaceTimeout;
      notesSpaceInput.addEventListener('input', () => {
        clearTimeout(notesSpaceTimeout);
        notesSpaceTimeout = setTimeout(updatePreview, 400);
      });

      window.printCalendar = function() {
        iframe.contentWindow.print();
      };

      window.addEventListener('beforeprint', () => {
        const iframeDoc = iframe.contentDocument;
        if (!iframeDoc) return;
        const mirror = document.createElement('div');
        mirror.id = 'print-mirror';
        const style = document.createElement('style');
        style.textContent = iframeDoc.querySelector('style').textContent;
        mirror.appendChild(style);
        mirror.insertAdjacentHTML('beforeend', iframeDoc.body.innerHTML);
        for (const child of document.body.children) {
          child.dataset.printHidden = child.style.display;
          child.style.display = 'none';
        }
        document.body.appendChild(mirror);
      });

      window.addEventListener('afterprint', () => {
        const mirror = document.getElementById('print-mirror');
        if (!mirror) return;
        mirror.remove();
        for (const child of document.body.children) {
          if ('printHidden' in child.dataset) {
            child.style.display = child.dataset.printHidden;
            delete child.dataset.printHidden;
          }
        }
      });

      let zoomLevel = 1.0;
      const zoomLabel = document.getElementById('zoom-label');

      window.zoomIn = function() {
        zoomLevel = Math.min(zoomLevel + 0.25, 5.0);
        applyZoom();
      };

      window.zoomOut = function() {
        zoomLevel = Math.max(zoomLevel - 0.25, 1.0);
        applyZoom();
      };

      window.resetZoom = function() {
        zoomLevel = 1.0;
        applyZoom();
      };

      function applyZoom() {
        zoomLabel.textContent = zoomLevel === 1.0 ? 'Auto' : Math.round(zoomLevel * 100) + '%';
        document.getElementById('zoom-out-btn').disabled = zoomLevel === 1.0;
        scalePreview();
      }

      function scalePreview() {
        const container = document.querySelector('.preview');
        const wrapper = document.getElementById('iframe-wrapper');
        const iframeW = 1122.5;  // 297mm in px at 96dpi
        const iframeH = 1587.4; // 420mm (2 × 210mm) in px at 96dpi

        if (isMobile()) {
          scaleMobilePreview();
          return;
        }

        const pad = 48;
        const availW = container.clientWidth - pad;
        const availH = container.clientHeight - pad;
        const fitScale = Math.min(availW / iframeW, availH / iframeH, 1);
        const scale = fitScale * zoomLevel;
        iframe.style.transform = 'scale(' + scale + ')';
        wrapper.style.width = (iframeW * scale) + 'px';
        wrapper.style.height = (iframeH * scale) + 'px';
        container.style.paddingTop = zoomLevel <= 1.0 ? (pad / 2) + 'px' : '0';
      }

      window.addEventListener('resize', () => {
        if (isMobile()) {
          mobileZoom = 1;
          previewEl.scrollLeft = 0;
          previewEl.scrollTop = 0;
        }
        if (isMobile() || zoomLevel === 1.0) scalePreview();
      });
      iframe.addEventListener('load', () => {
        iframe.style.visibility = 'visible';
        scalePreview();
      });

      await init();
      loadState();
      document.querySelector('.controls').style.visibility = 'visible';
      scalePreview();
      updatePreview();
    </script>
  </body>
</html>
